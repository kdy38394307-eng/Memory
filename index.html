<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <h1>Memory</h1>
  </div>
  <div class="container">
    <div id="mainMenu" class="main-menu">
      <div class="menu-grid">
        <button class="fortune-btn" onclick="showFortune()">
          <div class="btn-content">
            <span class="btn-icon">ğŸ”®</span>
            <span class="btn-text">ì˜¤ëŠ˜ì˜ ìš´ì„¸</span>
          </div>
        </button>
        <button class="lotto-btn" onclick="showLotto()">
          <div class="btn-content">
            <span class="btn-icon">ğŸ°</span>
            <span class="btn-text">Lotto</span>
          </div>
        </button>
      </div>
    </div>
    <div id="backBtn" class="back-button" style="display: none;">
      <button onclick="goBack()">â† ë’¤ë¡œ ê°€ê¸°</button>
    </div>
    <div id="result" class="result-box"></div>
  </div>
  <div class="visitor-counter">
    <span>ì˜¤ëŠ˜ ë°©ë¬¸ì: <span id="visitorCount">0</span>ëª…</span>
  </div>

  <!-- ë¡œê·¸ì¸ UI -->
  <div class="login-box" style="text-align:center; margin:20px;">
    <button onclick="loginWithEmail()">ì´ë©”ì¼ ë¡œê·¸ì¸</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <!-- Firebase SDK (Firestore, Storageë„ ì¶”ê°€) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAB_YVUYaPFvAah9y0409YtGsIC1fTw7oQ",
    authDomain: "memory-21fb7.firebaseapp.com",
    projectId: "memory-21fb7",
    storageBucket: "memory-21fb7.appspot.com",
    messagingSenderId: "45594315097",
    appId: "1:45594315097:web:c7a1f8609130ee7c4f6448",
    measurementId: "G-7F4WGD824F"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ì´ë©”ì¼ íšŒì›ê°€ì… í•¨ìˆ˜ (ë‹‰ë„¤ì„ í¬í•¨)
  async function registerWithEmail() {
    const email = prompt("ì´ë©”ì¼ ì…ë ¥:");
    const password = prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      // ì´ë©”ì¼ ì¸ì¦ ë©”ì¼ ì „ì†¡
      await user.sendEmailVerification();
      alert("íšŒì›ê°€ì… ì„±ê³µ! ì´ë©”ì¼ ì¸ì¦ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");

      // ë‹‰ë„¤ì„ ì…ë ¥ë°›ì•„ Firestore ì €ì¥
      const nickname = prompt("ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      await db.collection("users").doc(user.uid).set({
        email: user.email,
        nickname: nickname,
        createdAt: new Date()
      });

    } catch (error) {
      alert("ì—ëŸ¬: " + error.message);
    }
  }

  // ë¡œê·¸ì¸ í•¨ìˆ˜
  async function loginWithEmail() {
    const email = prompt("ì´ë©”ì¼ ì…ë ¥:");
    const password = prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");

    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;

      if (!user.emailVerified) {
        alert("ì´ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        await auth.signOut();
        return;
      }

      // Firestoreì—ì„œ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
      const doc = await db.collection("users").doc(user.uid).get();
      const nickname = doc.exists ? doc.data().nickname : "ë‹‰ë„¤ì„ ì—†ìŒ";

      alert(`${nickname}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);

    } catch (error) {
      alert("ì—ëŸ¬: " + error.message);
    }
  }

  // ë¡œê·¸ì•„ì›ƒ
  function logout() {
    auth.signOut();
    alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
  }

  // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
  auth.onAuthStateChanged(async (user) => {
    const box = document.querySelector(".login-box");
    if (user && user.emailVerified) {
      const doc = await db.collection("users").doc(user.uid).get();
      const nickname = doc.exists ? doc.data().nickname : "ë‹‰ë„¤ì„ ì—†ìŒ";
      box.innerHTML = `<p>${nickname}ë‹˜ ë¡œê·¸ì¸ ì¤‘</p><button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>`;
    } else {
      box.innerHTML = `
        <button onclick="registerWithEmail()">íšŒì›ê°€ì…</button>
        <button onclick="loginWithEmail()">ë¡œê·¸ì¸</button>`;
    }
  });
</script>
</body>
</html>
